<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  





  
  <title>Santosh Kumar Radha | Numba for Quantum optimization</title>
  <meta name="description" content="Personal webpage
">
  <!-- Google Analytics -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-142155886-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-142155886-1');
</script>
<!-- /Google Analytics -->

  

  <link rel="shortcut icon" href="http://localhost:4000/assets/img/favicon.ico">

  <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
  <link rel="canonical" href="http://localhost:4000/blog/2020/numba-for-quantum-codes/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        <a href="http://localhost:4000/"><strong>Santosh</strong> Radha</a>
    </span>
    

    <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>
      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="http://localhost:4000/">About</a>

        <!-- Blog -->
        <a class="page-link" href="http://localhost:4000/blog/">Blog</a>

        <!-- Pages -->
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
        
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
            <a class="page-link" href="http://localhost:4000/research/">Research</a>
            
            
          
        
          
            
            <a class="page-link" href="http://localhost:4000/publications/">Publications</a>
            
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
        
          
        



        <!-- github -->
        <a class="page-link" href="https://github.com/santoshkumarradha">Github</a>
        <!-- flicker -->
        <!-- <a class="page-link" href="https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=1&cad=rja&uact=8&ved=2ahUKEwj3sIP5grzdAhWmq1kKHX9zCA0QFjAAegQIBxAB&url=https%3A%2F%2Fwww.flickr.com%2Fphotos%2Fsantyphotography%2F&usg=AOvVaw3wIh929JJSpXgNa3DHo7cb">Photography</a> -->
        <!-- design -->
        <!-- <a class="page-link" href="https://www.behance.net/instrumentsantosh">Design</a> -->
        <!-- CV link -->
        <!-- <a class="page-link" href="http://localhost:4000/assets/pdf/CV.pdf">vitae</a> -->

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <script type="text/x-mathjax-config">
var font = "Neo-Euler";
MathJax.Hub.Config({
	tex2jax: {
		inlineMath: [['$','$']],
		displayMath: [['\\[','\\]']],
		processEscapes: true,
	},
	"SVG":{ 
		font:font
	},
	"HTML-CSS": {
		webFont: font,
		imageFont: font,
		preferredFont: font,
		availableFonts: [],
		scale: 85,
		mtextFontInherit: true
	}
}); </script> 

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML,https://idcrook.github.io/assets/js/MathJaxLocal.js"></script>
<div class="post">

  <header class="post-header">
    <h8 class="post-title">Numba for Quantum optimization</h8>
        <p class="post-meta">April 29, 2020</p>
        <p class="post-meta">
      <span>tags: 
    
      
      <a href="/tag/numba"><code class="highligher-rouge"><nobr>numba</nobr></code>&nbsp;</a>
    
      
      <a href="/tag/python"><code class="highligher-rouge"><nobr>python</nobr></code>&nbsp;</a>
    
      
      <a href="/tag/tight-binding"><code class="highligher-rouge"><nobr>tight-binding</nobr></code>&nbsp;</a>
    
      
      <a href="/tag/optimization"><code class="highligher-rouge"><nobr>optimization</nobr></code>&nbsp;</a>
    
      
      <a href="/tag/Slaster-koster"><code class="highligher-rouge"><nobr>Slaster-koster</nobr></code>&nbsp;</a>
    
      
      <a href="/tag/pysktb"><code class="highligher-rouge"><nobr>pysktb</nobr></code>&nbsp;</a>
    
      
      <a href="/tag/coding"><code class="highligher-rouge"><nobr>coding</nobr></code>&nbsp;</a>
    
  </span></p>

  </header>
  


  <article class="post-content">
    <p>Another appreciation post for numba. Couple of years ago, I had developed this package (<a href="https://github.com/santoshkumarradha/pysktb">pySKTB</a>) to help with calculating Eigen spectrum of system with co-dimensions $&gt;1$. This was done so that I could in theory do rudimentary testing of different symmetries and how it couples to the orbital/real-space symmetry. But one of the major problem I had was that the code was really clunky. Of course as is the case of all theoretical physics development, it happened because of adding bits and peaces when and wherever needed. After dabbling with numba, I learnt about the existence of couple of new tools like <code class="language-plaintext highlighter-rouge">line_profiler</code> which seems to be extremely useful for optimizing codes and I am baffled that i have never used this. But anyway, for people not familiar with this, it spits out time of run for each line in your code. Of-course the code being the beast it is, mine had every possible line sitting like a chump standing a solid ground. So I started with the biggest of a the chump, which was calculating $g_{ij}$, which is the $g$ matrix for connecting sites. Next comes the big catch, unlike normal jit, one cannot just add a decorator inside for this as calculating $g$ was done in a class. So the easiest plan i could think of was to add all numba functions in a separate module of optimized function and call it when needed from the main moduleâ€™s class. So I took the calculation off and added it to a separate module that i called optimizer and made it something like</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">nb</span><span class="p">.</span><span class="n">jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_gmat_jit</span><span class="p">(</span><span class="n">g_mat</span><span class="p">,</span><span class="n">all_iter</span><span class="p">,</span><span class="n">max_image</span><span class="p">,</span><span class="n">n_orbitals</span><span class="p">,</span><span class="n">bond_mat</span><span class="p">,</span><span class="n">dist_mat_vec</span><span class="p">,</span><span class="n">kpt_cart</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">ind_1</span><span class="p">,</span> <span class="p">(</span><span class="n">atom_1_i</span><span class="p">,</span> <span class="n">orbit_1_i</span><span class="p">,</span> <span class="n">element_1</span><span class="p">,</span> <span class="n">orbit_1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_iter</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">ind_2</span><span class="p">,</span> <span class="p">(</span><span class="n">atom_2_i</span><span class="p">,</span> <span class="n">orbit_2_i</span><span class="p">,</span> <span class="n">element_2</span><span class="p">,</span> <span class="n">orbit_2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_iter</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">image_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_image</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">bond_mat</span><span class="p">[</span><span class="n">image_ind</span><span class="p">,</span> <span class="n">atom_1_i</span><span class="p">,</span> <span class="n">atom_2_i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">dist_vec</span> <span class="o">=</span> <span class="n">dist_mat_vec</span><span class="p">[</span><span class="n">image_ind</span><span class="p">,</span> <span class="n">atom_1_i</span><span class="p">,</span> <span class="n">atom_2_i</span><span class="p">,</span> <span class="p">:]</span>

				<span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">1j</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">kpt_cart</span><span class="p">,</span> <span class="n">dist_vec</span><span class="p">))</span>
				<span class="n">g_mat</span><span class="p">[</span><span class="n">image_ind</span><span class="p">,</span> <span class="n">ind_1</span><span class="p">,</span> <span class="n">ind_2</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span>
	<span class="n">g_mat</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">max_image</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="p">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n_orbitals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">g_mat</span>
</code></pre></div></div>

<p>This unfortunately seems to through error when <code class="language-plaintext highlighter-rouge">nopython=True</code>. This usually happens because of the use of non fundamental objects like custom class object inside jit, but as far as I can see there seems to be nothing like that. But ignoring that and running in nopython mode still gave a huge boost to the performance. Here is a bench mark of that with respect to number of sites in the system (represented by supercell)</p>

<p align="center">
  <img width="50%" src="/assets/img/pysktb_numba.png" />
</p>

<p>Almost order $\approx 10$ improvement, not bad for couple of minutes of work. Next stop would be to parallelize the calculation with dask. But thats for another day.</p>

  </article>

  

</div>
<p></p>
<div class="lineHorizontal__container">
  <div class="lineHorizontal"></div>
</div>


 <h2>Topics to explore</h2>



  
  
  <a href="/tag/physics"><code class="highligher-rouge"><nobr>physics</nobr></code></a>

  
  
  <a href="/tag/coding"><code class="highligher-rouge"><nobr>coding</nobr></code></a>

  
  
  <a href="/tag/topology"><code class="highligher-rouge"><nobr>topology</nobr></code></a>

  
  
  <a href="/tag/python"><code class="highligher-rouge"><nobr>python</nobr></code></a>

  
  
  <a href="/tag/perovskite"><code class="highligher-rouge"><nobr>perovskite</nobr></code></a>

  
  
  <a href="/tag/numba"><code class="highligher-rouge"><nobr>numba</nobr></code></a>

  
  
  <a href="/tag/Quantum"><code class="highligher-rouge"><nobr>Quantum</nobr></code></a>

  
  
  <a href="/tag/Monte-carlo"><code class="highligher-rouge"><nobr>Monte-carlo</nobr></code></a>

  
  
  <a href="/tag/Julia"><code class="highligher-rouge"><nobr>Julia</nobr></code></a>

  
  
  <a href="/tag/tight-binding"><code class="highligher-rouge"><nobr>tight-binding</nobr></code></a>

  
  
  <a href="/tag/talk"><code class="highligher-rouge"><nobr>talk</nobr></code></a>

  
  
  <a href="/tag/susceptibility"><code class="highligher-rouge"><nobr>susceptibility</nobr></code></a>

  
  
  <a href="/tag/spin-waves"><code class="highligher-rouge"><nobr>spin-waves</nobr></code></a>

  
  
  <a href="/tag/quantum"><code class="highligher-rouge"><nobr>quantum</nobr></code></a>

  
  
  <a href="/tag/quamtum"><code class="highligher-rouge"><nobr>quamtum</nobr></code></a>

  
  
  <a href="/tag/pysktb"><code class="highligher-rouge"><nobr>pysktb</nobr></code></a>

  
  
  <a href="/tag/optimization"><code class="highligher-rouge"><nobr>optimization</nobr></code></a>

  
  
  <a href="/tag/grover"><code class="highligher-rouge"><nobr>grover</nobr></code></a>

  
  
  <a href="/tag/finance"><code class="highligher-rouge"><nobr>finance</nobr></code></a>

  
  
  <a href="/tag/field-theory"><code class="highligher-rouge"><nobr>field-theory</nobr></code></a>

  
  
  <a href="/tag/algorithm"><code class="highligher-rouge"><nobr>algorithm</nobr></code></a>

  
  
  <a href="/tag/advisor"><code class="highligher-rouge"><nobr>advisor</nobr></code></a>

  
  
  <a href="/tag/addition"><code class="highligher-rouge"><nobr>addition</nobr></code></a>

  
  
  <a href="/tag/Superconductivity"><code class="highligher-rouge"><nobr>Superconductivity</nobr></code></a>

  
  
  <a href="/tag/Slaster-koster"><code class="highligher-rouge"><nobr>Slaster-koster</nobr></code></a>

  
  
  <a href="/tag/QFT"><code class="highligher-rouge"><nobr>QFT</nobr></code></a>

  
  
  <a href="/tag/Physics"><code class="highligher-rouge"><nobr>Physics</nobr></code></a>

  
  
  <a href="/tag/BdG"><code class="highligher-rouge"><nobr>BdG</nobr></code></a>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2021 Santosh Kumar Radha.
    
    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="http://localhost:4000/assets/js/common.js"></script>


<!-- Load KaTeX -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
<script src="http://localhost:4000/assets/js/katex.js"></script>




<!-- Include custom icon fonts -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/fontawesome-all.min.css">
<link rel="stylesheet" href="http://localhost:4000/assets/css/academicons.min.css">




  </body>

</html>
